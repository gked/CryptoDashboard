<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Bitcoin and Satoshi Converter</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    </head>
    <body>
        <div>
            <div class="field-label is-normal is-justify-content-center has-text-centered mt-5">
                <label class="label tag is-primary is-medium"><span>Current Bitcoin Price</span> =  $ <span contenteditable="true" id="priceDisplay"></span></label>
             </div>
            <section class="section is-max-desktop has-background-primary-light mt-2">
                <div class="is-family-monospace container">
                    <h1 class="has-text-centered title is-size-4 is-justify-content-center mt-s">Convert between Bitcoins, Satoshis and Dollars</h1>
                    <div class="field">
                        <div class="control">
                            <input class="input is-primary" placeholder="Bitcoin Amount" type="number" id="bitcoinInput">
                        </div>
                    </div>
                    <div class="field">
                        <div class="control">
                            <input class="input is-primary" placeholder="Satoshi Amount" type="number" id="satoshiInput">
                        </div>
                    </div>
                    <div class="field">
                        <div class="control">
                            <input class="input is-primary" placeholder="Dollar Ammount" type="number" id="dollarInput">
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <script>
            // current price of one bitcoin in dollars
            let bitcoinPrice = 0
            // amount  of satoshis in one bitcoin
            const oneHundredMillion = 100000000
            // assign user-friendly names for elements to make it easier working with them
            const priceDisplay = document.getElementById('priceDisplay')
            const bitcoinInput = document.getElementById('bitcoinInput')
            const satoshiInput = document.getElementById('satoshiInput')
            const dollarInput = document.getElementById('dollarInput')

            // on DOMLoad, make a call into the ticker to get Bitcoin price
            window.onload = (event) => {
                getBitcoinPriceAndUpdateVisuals()
            };

            // listen to input events to convert a value 
            // entered by the user to another representations
            // e.g if bitcoin input is being updated - convert the value 
            // to satoshi and dollar ammount
            document.addEventListener('input', updateValue)

            /* updateValue function updates fields related to the field 
               being updated by the user
            */
            function updateValue(e) {
                /* bitcoinInput filed is being updated:
                   1. convert to satoshi by mutliplying bitcoin value by oneHundredMillion satoshi (amount of satoshi in one bitcoin)
                   2. convert to dollars by mutliplying bitcoin value by price of bitcoin constant. bitcoinPrice constant is updated dynamicall by calling into the service
                */
                if(e.srcElement.id === 'bitcoinInput') {
                    const satoshiEquivalent = e.target.value * oneHundredMillion
                    const dollarEquivalent = e.target.value * bitcoinPrice
                    satoshiInput.value = satoshiEquivalent
                    dollarInput.value = dollarEquivalent
                }
                /* satoshiInput filed is being updated:
                   1. convert to bitcoin by dividing satoshi value by oneHundredMillion satoshi (amount of satoshi in one bitcoin)
                   2. convert to dollars by mutliplying bitcoin value derived in step one by price of bitcoin constant. bitcoinPrice constant is updated dynamicall by calling into the service.
                */
                else if(e.srcElement.id === 'satoshiInput') {
                    const bitcoinEquivalent = e.target.value / oneHundredMillion
                    const dollarEquivalent = bitcoinEquivalent * bitcoinPrice
                    bitcoinInput.value = bitcoinEquivalent
                    dollarInput.value = dollarEquivalent
                }
                /* dollarInput filed is being updated:
                   1. convert to bitcoin by dividing dollar value by bitcoinPrice constant. bitcoinPrice constant is updated dynamicall by calling into the service.
                   2. convert to satoshi by mutliplying bitcoin value derived in step one by oneHundredMillion constant. oneHundredMillion - amount of satoshi in one bitcoin
                */
                else if(e.srcElement.id === 'dollarInput') {
                    const bitcoinEquivalent = e.target.value / bitcoinPrice
                    const satoshiEquivalent = bitcoinEquivalent * oneHundredMillion
                    bitcoinInput.value = bitcoinEquivalent
                    satoshiInput.value = satoshiEquivalent
                }
            }
            /*  getBitcoinPriceAndUpdateVisuals calls into the ticker, returns json
                of bitcoin prices in different currencies. It then picks price in US dollars
                and updates priceDisplay input and bitcoinPrice 
            */
            function getBitcoinPriceAndUpdateVisuals() {
                let xhr = new XMLHttpRequest()
                xhr.open('GET', 'https://blockchain.info/ticker', true)
                xhr.send()
                xhr.onload = function() {
                    const jsonData = JSON.parse(xhr.response)
                    const lastBitcoinPrice = jsonData.USD.last
                    bitcoinPrice = priceDisplay.innerText = lastBitcoinPrice
                }
            }
        </script>
    </body>
</html>